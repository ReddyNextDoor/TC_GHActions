name: Template Deploy

on:
  workflow_call:
    inputs:
      environments:
        required: true
        type: string
        description: "JSON array of environments to deploy"

jobs:
  deploy:
    runs-on: [self-hosted, linux, ARM64, a8bc952bca85]
    strategy:
      matrix:
        environment: ${{ fromJson(inputs.environments) }}
    
    concurrency:
      group: deploy-${{ matrix.environment }}
      cancel-in-progress: false
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Prepare deployment directory
        run: |
          echo "üöÄ Deploying to ${{ matrix.environment }}"
          echo "üìä Database: testdb_${{ matrix.environment }}"
          
          # Create deployment directory
          mkdir -p /tmp/deployments/${{ matrix.environment }}
          
      - name: Deploy config artifact
        run: |
          # Copy config.yml to deployment location
          cp test_db/${{ matrix.environment }}/config.yml /tmp/deployments/${{ matrix.environment }}/
          echo "üì¶ Config deployed to /tmp/deployments/${{ matrix.environment }}/"
          
      - name: Verify deployment
        run: |
          echo "üîç Verifying deployed config for ${{ matrix.environment }}:"
          echo "----------------------------------------"
          cat /tmp/deployments/${{ matrix.environment }}/config.yml
          echo "----------------------------------------"
          
      - name: Create deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployed-config-${{ matrix.environment }}
          path: /tmp/deployments/${{ matrix.environment }}/config.yml
          retention-days: 7
          
      - name: Complete deployment
        run: |
          sleep 5  # Simulate deployment time
          echo "‚úÖ Deployment complete for ${{ matrix.environment }}"
          echo "üìç Config available at: /tmp/deployments/${{ matrix.environment }}/config.yml"
