name: Template Deploy

on:
  workflow_call:
    inputs:
      environments:
        required: true
        type: string
        description: "JSON array of environments to deploy"

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: ${{ fromJson(inputs.environments) }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Prepare build artifacts
        run: |
          echo "ğŸ”¨ Building artifacts for ${{ matrix.environment }}"
          echo "ğŸ“¦ Processing config for environment: ${{ matrix.environment }}"
          
          # Create build directory
          mkdir -p build-artifacts/${{ matrix.environment }}
          
      - name: Package config artifact
        run: |
          # Copy and prepare config for deployment
          cp test_db/${{ matrix.environment }}/config.yml build-artifacts/${{ matrix.environment }}/
          
          # Add build metadata
          echo "# Build Information" >> build-artifacts/${{ matrix.environment }}/config.yml
          echo "build_time: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> build-artifacts/${{ matrix.environment }}/config.yml
          echo "build_id: ${{ github.run_id }}" >> build-artifacts/${{ matrix.environment }}/config.yml
          echo "commit_sha: ${{ github.sha }}" >> build-artifacts/${{ matrix.environment }}/config.yml
          
          echo "ğŸ“¦ Config artifact ready for ${{ matrix.environment }}"
          
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: config-${{ matrix.environment }}
          path: build-artifacts/${{ matrix.environment }}/config.yml
          retention-days: 7

  deploy:
    runs-on: [self-hosted, linux, ARM64, a8bc952bca85]
    needs: build
    strategy:
      matrix:
        environment: ${{ fromJson(inputs.environments) }}
    
    concurrency:
      group: deploy-${{ matrix.environment }}
      cancel-in-progress: false
    
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: config-${{ matrix.environment }}
          path: ./artifacts/
      
      - name: Prepare deployment directory
        run: |
          echo "ğŸš€ Deploying to ${{ matrix.environment }}"
          echo "ğŸ“Š Database: testdb_${{ matrix.environment }}"
          
          # Create deployment directory with versioning
          DEPLOY_DIR="/tmp/deployments/${{ matrix.environment }}"
          VERSION_DIR="${DEPLOY_DIR}/versions/$(date +%Y%m%d-%H%M%S)-${{ github.run_id }}"
          
          mkdir -p "$DEPLOY_DIR"
          mkdir -p "$VERSION_DIR"
          
          echo "ğŸ“ Deployment directory: $DEPLOY_DIR"
          echo "ğŸ“ Version directory: $VERSION_DIR"
          
      - name: Deploy config artifact
        run: |
          DEPLOY_DIR="/tmp/deployments/${{ matrix.environment }}"
          VERSION_DIR="${DEPLOY_DIR}/versions/$(date +%Y%m%d-%H%M%S)-${{ github.run_id }}"
          
          # Deploy to versioned location
          cp ./artifacts/config.yml "$VERSION_DIR/"
          
          # Update current deployment (replace existing)
          cp ./artifacts/config.yml "$DEPLOY_DIR/config.yml"
          
          echo "ğŸ“¦ Config deployed to $DEPLOY_DIR/config.yml"
          echo "ğŸ’¾ Version saved to $VERSION_DIR/config.yml"
          
      - name: Verify deployment
        run: |
          echo "ğŸ” Verifying deployed config for ${{ matrix.environment }}:"
          echo "----------------------------------------"
          cat /tmp/deployments/${{ matrix.environment }}/config.yml
          echo "----------------------------------------"
          
          echo "ğŸ“‹ Available versions:"
          ls -la /tmp/deployments/${{ matrix.environment }}/versions/ || echo "No previous versions"
          
      - name: Complete deployment
        run: |
          sleep 3  # Simulate deployment time
          echo "âœ… Deployment complete for ${{ matrix.environment }}"
          echo "ğŸ“ Current config: /tmp/deployments/${{ matrix.environment }}/config.yml"
          echo "ğŸ“š Versions: /tmp/deployments/${{ matrix.environment }}/versions/"
